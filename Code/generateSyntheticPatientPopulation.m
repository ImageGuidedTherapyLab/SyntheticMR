% This is a script to generate and save high-res and low-res versions of 10
% different label masks representing 10 different patients. The differences
% are created by dilating and eroding the label masks.

%% Population Tissue Statistics

% GM/WM/CSF M0/T1/T2 Values
%              GM    WM   CSF  Tumor
T1mean = [1200,  900, 4000, 1200]./1000; % s
T1stdd = [ 100,  100,  200,  150]./1000; % s

T2mean = [ 100,   80, 1000,  110]./1000; % s
T2stdd = [   5,    4,   50,   10]./1000; % s

M0mean = [ 0.9,  0.9,  1.0,  0.9];       % relative intensity
M0stdd = [ .05,  .05,  .05,   .1];       % relative intensity

tisinput=[M0mean;M0stdd;T1mean;T1stdd;T2mean;T2stdd];

%% Define Individual Patient Geometries

lfname = '/rsrch1/ip/dmitchell2/github/SyntheticMR/Code/ICBM_grey_white_csf.nii.gz'; % population tissue segmentation

dilatearg=...
    [1,1,1,2,2,2,3,3,3;...
    0,0,0,0,0,0,0,0,0;...
    1,1,1,1,1,1,1,1,1;...
    2,2,2,2,2,2,2,2,2;...
    1,1,1,2,2,2,2,2,2;...
    0,0,0,0,0,0,0,0,0;...
    0,0,0,1,1,1,0,0,0;...
    0,0,0,0,0,0,0,0,0;...
    1,1,1,0,0,0,1,1,1;...
    0,0,0,2,2,2,0,0,0];
erodearg=...
    [0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0;...
    0,0,0,0,0,0,0,0,0;...
    1,1,1,0,0,0,0,0,0;...
    0,0,0,0,0,0,1,1,1;...
    2,2,2,0,0,0,0,0,0;...
    0,0,0,1,1,1,0,0,0;...
    1,1,1,0,0,0,1,1,1];

%% Iterate to Create Individual Patient Geometries and Tissue Statistics

syntheticPatientPop=cell(size(dilatearg,1),2);
for iii=1:size(dilatearg,1)
    
    % High res
    syscommand=sprintf(['/opt/apps/itksnap/c3d-1.1.0-Linux-x86_64/bin/c3d %s ',...
        '-dilate 1 %ix%ix%ivox -dilate 2 %ix%ix%ivox -dilate 3 %ix%ix%ivox ',...
        '-erode 1 %ix%ix%ivox -erode 2 %ix%ix%ivox -erode 3 %ix%ix%ivox ',...
        '-interpolation NearestNeighbor -resample %ix%ix%i -o resampleimg.nii.gz'],...
        lfname,dilatearg(iii,1),dilatearg(iii,2),dilatearg(iii,3),dilatearg(iii,4),dilatearg(iii,5),dilatearg(iii,6),...
        dilatearg(iii,7),dilatearg(iii,8),dilatearg(iii,9),erodearg(iii,1),erodearg(iii,2),erodearg(iii,3),...
        erodearg(iii,4),erodearg(iii,5),erodearg(iii,6),erodearg(iii,7),erodearg(iii,8),erodearg(iii,9),181,217,181);
    
    system(syscommand);
    tmptissue=load_untouch_nii('resampleimg.nii.gz');
    system('rm resampleimg.nii.gz');
    materialID=tmptissue.img;
    
    syntheticPatientPop{iii,1}=materialID;
    
    % Low res
    syscommand=sprintf(['/opt/apps/itksnap/c3d-1.1.0-Linux-x86_64/bin/c3d %s ',...
        '-dilate 1 %ix%ix%ivox -dilate 2 %ix%ix%ivox -dilate 3 %ix%ix%ivox ',...
        '-erode 1 %ix%ix%ivox -erode 2 %ix%ix%ivox -erode 3 %ix%ix%ivox ',...
        '-interpolation NearestNeighbor -resample %ix%ix%i -o resampleimg.nii.gz'],...
        lfname,dilatearg(iii,1),dilatearg(iii,2),dilatearg(iii,3),dilatearg(iii,4),dilatearg(iii,5),dilatearg(iii,6),...
        dilatearg(iii,7),dilatearg(iii,8),dilatearg(iii,9),erodearg(iii,1),erodearg(iii,2),erodearg(iii,3),...
        erodearg(iii,4),erodearg(iii,5),erodearg(iii,6),erodearg(iii,7),erodearg(iii,8),erodearg(iii,9),45,54,45);
    
    system(syscommand);
    tmptissue=load_untouch_nii('resampleimg.nii.gz');
    system('rm resampleimg.nii.gz');
    materialID=tmptissue.img;
    
    syntheticPatientPop{iii,2}=materialID;
    
    % Generate intra-patient tissue statistics
    syntheticPatientPop{iii,3}(1:2:size(tisinput,1),:)=normrnd(tisinput(1:2:end,:),tisinput(2:2:end,:));
    syntheticPatientPop{iii,3}(2:2:size(tisinput,1),:)=tisinput(2:2:end,:)./2;
    
end

save syntheticPatientPopulation.mat syntheticPatientPop -v7.3;